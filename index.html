<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>Ch·∫°y V√¥ T·∫≠n: T√¨nh B·∫°n+ (B·∫£n N√¢ng C·∫•p)</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;600;800&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#e9f5ff;
    --ink:#0b2545;
    --good:#16a34a;
    --bad:#dc2626;
    --accent:#2563eb;
    --gold:#f59e0b;
    --card:#ffffffcc;
  }
  *{box-sizing:border-box}
  html,body{
    height:100%;
    margin:0;
    font-family:'Be Vietnam Pro',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;
    background: linear-gradient(180deg,#eaf6ff 0%,#f7fbff 55%,#ffffff 100%);
    color:var(--ink);
    overflow:hidden;
  }
  .page{
    display:flex;flex-direction:column;align-items:center;gap:12px;padding:12px;height:100%;
  }

  /* GAME AREA */
  .game-shell{
    position:relative;
    width: min(900px, 96vw);
    aspect-ratio: 16/9;
    border-radius: 18px;
    overflow:hidden;
    box-shadow: 0 20px 50px rgba(13,37,69,.15);
    background: #cfe9ff;
    border:2px solid #b5d9ff;
  }
  .layer{ position:absolute; inset:0; }
  .sky{
    background: linear-gradient(180deg,#cfe9ff 0%,#e9f5ff 65%,#fff 100%);
  }
  .cloud{
    position:absolute; top:10%; width:140px; height:50px; background:#fff; opacity:.85; border-radius:40px;
    box-shadow: 60px 10px 0 10px #fff, 20px -10px 0 8px #fff, 90px -5px 0 6px #fff;
    animation: cloudMove linear infinite;
  }
  .cloud.c1{ top:12%; left:-180px; animation-duration: 28s;}
  .cloud.c2{ top:22%; left:-260px; transform: scale(1.1); animation-duration: 36s;}
  .cloud.c3{ top:35%; left:-220px; transform: scale(.85); animation-duration: 24s;}
  @keyframes cloudMove { from{ transform: translateX(0) } to{ transform: translateX(120vw)} }

  .ground{
    position:absolute; left:0; right:0; height:18%;
    bottom:0; background:linear-gradient(180deg,#a7d08c 0%,#7fc16b 60%,#65a856 100%);
    border-top: 2px solid #6fbf6a;
  }
  .lane{
    position:absolute; left:0; right:0; bottom:18%;
    height:4px; background: repeating-linear-gradient(90deg,#fff 0 30px, #d9f4d9 30px 60px);
    opacity:.8;
  }

  /* HUD */
  .hud{
    position:absolute; top:10px; left:10px; right:10px; display:flex; align-items:center; justify-content:space-between; gap:8px; z-index:10;
  }
  .pill{
    background:var(--card); backdrop-filter: blur(8px);
    border:1px solid #e6f2ff; border-radius: 999px; padding:6px 12px; display:flex; gap:8px; align-items:center; font-weight:600;
    box-shadow: 0 6px 20px rgba(13,37,69,.08);
  }
  .btn-icon{
    border:none; background:var(--card); border:1px solid #e6f2ff;
    border-radius: 12px; padding:8px 10px; display:inline-flex; align-items:center; gap:6px; cursor:pointer;
    box-shadow: 0 6px 20px rgba(13,37,69,.08);
  }
  .btn-icon:active{ transform: translateY(1px) }
  .badge-diff{
    font-size:.8rem; padding:.2rem .5rem; border-radius:999px; border:1px solid #e6f2ff; background:#fff;
  }

  /* ENTITIES */
  .entity{ position:absolute; will-change: transform; }
  .player{
    width:56px; height:56px; border-radius:14px; display:flex; align-items:center; justify-content:center;
    color:#fff; font-size:26px; font-weight:800;
    box-shadow: 0 10px 22px rgba(0,0,0,.15), inset 0 0 0 2px #ffffff22;
    user-select:none;
  }
  .p-blue{ background: linear-gradient(145deg,#3b82f6,#1d4ed8)}
  .p-pink{ background: linear-gradient(145deg,#ec4899,#be185d)}
  .p-green{ background: linear-gradient(145deg,#22c55e,#16a34a)}
  .p-gold{ background: linear-gradient(145deg,#f59e0b,#d97706)}

  .shadow{
    position:absolute; width:50px; height:8px; background: radial-gradient(ellipse at center, rgba(0,0,0,.25) 0%, rgba(0,0,0,0) 70%);
    bottom: calc(18% + 2px); transform: translateX(-50%); pointer-events:none;
  }

  .obstacle, .collectible, .powerup{
    padding:8px 14px; border-radius:10px; font-weight:700; color:#fff; white-space:nowrap; pointer-events:none;
    border:1px solid #ffffff33; box-shadow: 0 8px 18px rgba(0,0,0,.18);
  }
  .obstacle{ background: linear-gradient(145deg,#ef4444,#b91c1c)}
  .collectible{ background: linear-gradient(145deg,#22c55e,#15803d)}
  .powerup{ background: linear-gradient(145deg,#f59e0b,#b45309)}

  /* OVERLAYS */
  .overlay{
    position:absolute; inset:0; z-index:20; display:flex; align-items:center; justify-content:center;
    background: linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.65));
    backdrop-filter: blur(6px);
  }
  .cardx{
    width:min(680px,92%); background:#fff; border:1px solid #eef4ff; border-radius:18px; padding:18px;
    box-shadow: 0 25px 60px rgba(13,37,69,.18);
  }

  .choice{ display:flex; gap:12px; flex-wrap:wrap; }
  .chip{
    border:1px solid #e7efff; border-radius:12px; padding:10px 12px; cursor:pointer; display:flex; align-items:center; gap:8px;
    background:#f9fbff;
  }
  .chip.active{ outline:2px solid var(--accent); background:#eef5ff }

  /* MOBILE CONTROLS */
  .mobile-ctrl{
    position:absolute; inset:0; display:flex; align-items:flex-end; justify-content:center; padding:12px; z-index:9; pointer-events:none;
  }
  /* Cho c·∫£m ·ª©ng m∆∞·ª£t khi gi·ªØ */
  #game, .mobile-ctrl, .jump-btn { touch-action: none; }

  .jump-btn{
    pointer-events:auto; border:none; border-radius:999px; padding:14px 24px; font-weight:800; font-size:1.1rem; color:#fff;
    background: linear-gradient(145deg,#2563eb,#1e3a8a); box-shadow: 0 12px 26px rgba(37,99,235,.35);
  }

  /* TOAST */
  .toastx{
    position:absolute; left:50%; top:16%; transform: translateX(-50%);
    background:#111827; color:#fff; padding:8px 12px; border-radius:10px; font-weight:600; opacity:0; transition: .25s;
    z-index:25;
  }
  .toastx.show{ opacity:1; transform: translateX(-50%) translateY(0) }

  @media (max-width:576px){
    .player{ width:50px; height:50px; font-size:22px }
  }
</style>
</head>
<body>
<div class="page">

  <div class="game-shell" id="game">
    <!-- BACKGROUND -->
    <div class="layer sky">
      <div class="cloud c1"></div>
      <div class="cloud c2"></div>
      <div class="cloud c3"></div>
    </div>
    <div class="layer lane"></div>
    <div class="layer ground"></div>

    <!-- HUD -->
    <div class="layer hud">
      <div class="pill" id="scorePill"><i class="bi bi-trophy-fill text-warning"></i> <span>ƒêi·ªÉm:</span> <span id="score">0</span></div>
      <div class="pill"><i class="bi bi-star-fill text-warning"></i> K·ª∑ l·ª•c: <span id="best">0</span></div>
      <div class="pill"><i class="bi bi-heart-fill text-danger"></i> M·∫°ng: <span id="lives">3</span></div>
      <div class="pill"><i class="bi bi-lightning-charge-fill text-warning"></i> C·∫•p: <span id="level">1</span> <span class="badge-diff ms-2" id="diffBadge">D·ªÖ</span></div>
      <div class="d-flex gap-2">
        <button class="btn-icon" id="btnPause"><i class="bi bi-pause-fill"></i><span class="d-none d-sm-inline">T·∫°m d·ª´ng</span></button>
        <button class="btn-icon" id="btnMute"><i class="bi bi-volume-up-fill"></i></button>
        <button class="btn-icon" id="btnRestart"><i class="bi bi-arrow-repeat"></i></button>
      </div>
    </div>

    <!-- PLAYER + SHADOW -->
    <div class="layer">
      <div class="entity player p-blue" id="player" aria-label="Nh√¢n v·∫≠t" role="img">üôÇ</div>
      <div class="shadow" id="shadow"></div>
    </div>

    <!-- ENTITIES CONTAINER -->
    <div class="layer" id="entities"></div>

    <!-- OVERLAYS -->
    <div class="overlay" id="startOverlay" aria-modal="true" role="dialog">
      <div class="cardx">
        <h2 class="fw-bold mb-2"><i class="bi bi-controller"></i> Ch·∫°y V√¥ T·∫≠n: X√¢y D·ª±ng T√¨nh B·∫°n+</h2>
        <p class="text-secondary mb-3">ƒÇn <span class="text-success fw-bold">H√†nh vi T·ªët</span> ƒë·ªÉ c·ªông ƒëi·ªÉm, tr√°nh <span class="text-danger fw-bold">H√†nh vi X·∫•u</span>. Nh·∫∑t <span class="text-warning fw-bold">Khi√™n</span> ƒë·ªÉ ch·∫∑n 1 l·∫ßn va ch·∫°m.</p>

        <div class="mb-3">
          <div class="fw-bold mb-1">ƒêi·ªÅu khi·ªÉn</div>
          <div>- M√°y t√≠nh: gi·ªØ ph√≠m <kbd>Space</kbd> ƒë·ªÉ <b>nh·∫£y/gi·ªØ bay</b>, nh·∫£ ƒë·ªÉ r∆°i. <kbd>P</kbd> t·∫°m d·ª´ng.</div>
          <div>- ƒêi·ªán tho·∫°i: <b>nh·∫•n & gi·ªØ</b> n√∫t NH·∫¢Y/BAY ho·∫∑c <b>ch·∫°m & gi·ªØ</b> m√†n h√¨nh ƒë·ªÉ bay, nh·∫£ ƒë·ªÉ r∆°i.</div>
        </div>

        <div class="row g-3">
          <div class="col-md-6">
            <label class="fw-bold mb-1">Ch·ªçn nh√¢n v·∫≠t</label>
            <div class="choice" id="charChoice">
              <div class="chip active" data-char="blue"><div class="player p-blue" style="width:36px;height:36px;font-size:18px;">üôÇ</div> Xanh</div>
              <div class="chip" data-char="pink"><div class="player p-pink" style="width:36px;height:36px;font-size:18px;">üò∫</div> H·ªìng</div>
              <div class="chip" data-char="green"><div class="player p-green" style="width:36px;height:36px;font-size:18px;">ü¶ä</div> L·ª•c</div>
              <div class="chip" data-char="gold"><div class="player p-gold" style="width:36px;height:36px;font-size:18px;">üêª</div> V√†ng</div>
            </div>
          </div>
          <div class="col-md-6">
            <label class="fw-bold mb-1">ƒê·ªô kh√≥</label>
            <div class="choice" id="diffChoice">
              <div class="chip active" data-diff="easy"><i class="bi bi-emoji-smile"></i> D·ªÖ</div>
              <div class="chip" data-diff="normal"><i class="bi bi-emoji-neutral"></i> V·ª´a</div>
              <div class="chip" data-diff="hard"><i class="bi bi-emoji-dizzy"></i> Kh√≥</div>
            </div>
          </div>
        </div>

        <hr class="my-3">
        <div class="d-flex gap-2">
          <button class="btn btn-primary btn-lg" id="btnStart"><i class="bi bi-play-fill"></i> B·∫Øt ƒë·∫ßu</button>
          <button class="btn btn-outline-secondary" id="btnHow">Lu·∫≠t & G·ª£i √Ω</button>
        </div>
        <div class="small text-secondary mt-2">Tip: Nh·∫£y s·ªõm 1 ch√∫t ƒë·ªÉ v∆∞·ª£t ch∆∞·ªõng ng·∫°i t·ªëc ƒë·ªô cao. Khi√™n t·ªìn t·∫°i 8 gi√¢y.</div>
      </div>
    </div>

    <div class="overlay d-none" id="gameOver" aria-modal="true" role="dialog">
      <div class="cardx text-center">
        <h3 class="fw-bold">K·∫øt th√∫c!</h3>
        <div class="display-6 text-primary">ƒêi·ªÉm: <span id="finalScore">0</span></div>
        <div class="mt-1">K·ª∑ l·ª•c: <span class="fw-bold" id="finalBest">0</span></div>
        <div class="mt-3 d-flex justify-content-center gap-2">
          <button class="btn btn-primary" id="btnPlayAgain"><i class="bi bi-arrow-repeat"></i> Ch∆°i l·∫°i</button>
          <button class="btn btn-outline-secondary" id="btnChange"><i class="bi bi-sliders"></i> ƒê·ªïi nh√¢n v·∫≠t/ƒë·ªô kh√≥</button>
        </div>
      </div>
    </div>

    <!-- MOBILE CONTROLS -->
    <div class="mobile-ctrl">
      <button class="jump-btn" id="btnJump"><i class="bi bi-chevron-up"></i> NH·∫¢Y / BAY (GI·ªÆ)</button>
    </div>

    <!-- TOAST -->
    <div class="toastx" id="toast">+10 ƒëi·ªÉm</div>
  </div>

  <!-- Notes accordion -->
  <div class="container" style="max-width:900px; overflow:auto;">
    <h2 class="text-center fw-bold mt-2">N·ªôi dung ghi b√†i üìù</h2>
    <div class="accordion mb-3" id="noteAcc">
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button" data-bs-toggle="collapse" data-bs-target="#n1">B√†i h·ªçc t·ª´ "H√†nh vi t·ªët" <i class="bi bi-check-circle-fill text-success ms-2"></i></button>
        </h2>
        <div id="n1" class="accordion-collapse collapse show">
          <div class="accordion-body">
            <ul class="mb-0">
              <li><b>Gi√∫p ƒë·ª°, b·∫£o v·ªá b·∫°n:</b> lu√¥n s·∫µn s√†ng khi b·∫°n g·∫∑p kh√≥ khƒÉn.</li>
              <li><b>H·ªçc nh√≥m ‚Äì c√πng ti·∫øn b·ªô:</b> h·ª£p t√°c l√† ch√¨a kh√≥a.</li>
              <li><b>L·∫Øng nghe ‚Äì t√¥n tr·ªçng:</b> t√¥n tr·ªçng kh√°c bi·ªát.</li>
              <li><b>Ch·∫∑n/B√°o c√°o:</b> d√πng c√¥ng c·ª• an to√†n tr√™n m·∫°ng.</li>
            </ul>
          </div>
        </div>
      </div>
      <div class="accordion-item mt-2">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" data-bs-toggle="collapse" data-bs-target="#n2">B√†i h·ªçc t·ª´ "H√†nh vi x·∫•u" <i class="bi bi-x-circle-fill text-danger ms-2"></i></button>
        </h2>
        <div id="n2" class="accordion-collapse collapse">
          <div class="accordion-body">
            <ul class="mb-0">
              <li><b>Tin ƒë·ªìn, n√≥i x·∫•u:</b> kh√¥ng tham gia, kh√¥ng c·ªï v≈©.</li>
              <li><b>B·∫Øt n·∫°t online:</b> d·ª´ng l·∫°i v√† xin tr·ª£ gi√∫p.</li>
              <li><b>Ng∆∞·ªùi l·∫° online:</b> gi·ªØ k√≠n th√¥ng tin c√° nh√¢n.</li>
              <li><b>R·ªß r√™ x·∫•u:</b> m·∫°nh d·∫°n t·ª´ ch·ªëi.</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
/* ======= TI·ªÜN √çCH √ÇM THANH NH·∫∏ ======= */
function makeBeep(freq=880, dur=80, vol=0.06){
  try{
    const ctx = (makeBeep.ctx ||= new (window.AudioContext||window.webkitAudioContext)());
    const o = ctx.createOscillator(); const g = ctx.createGain();
    o.type='sine'; o.frequency.value=freq; g.gain.value=vol;
    o.connect(g).connect(ctx.destination);
    o.start(); o.stop(ctx.currentTime + dur/1000);
  }catch(e){ /* no audio */ }
}

/* ======= NGU·ªíN D·ªÆ LI·ªÜU ======= */
const GOOD = [
  { text:'Gi√∫p ƒë·ª° b·∫°n <i class="bi bi-heart-fill"></i>', pts:10 },
  { text:'B·∫£o v·ªá b·∫°n <i class="bi bi-shield-fill-check"></i>', pts:10 },
  { text:'H·ªçc nh√≥m <i class="bi bi-book-fill"></i>', pts:6 },
  { text:'L·∫Øng nghe <i class="bi bi-ear-fill"></i>', pts:6 },
  { text:'Ch·∫∑n ng∆∞·ªùi x·∫•u <i class="bi bi-slash-circle-fill"></i>', pts:14 },
];
const BAD = [
  'Tin ƒë·ªìn <i class="bi bi-cloud-slash-fill"></i>',
  'N√≥i x·∫•u <i class="bi bi-chat-right-text-fill"></i>',
  'B·∫Øt n·∫°t Online <i class="bi bi-emoji-angry-fill"></i>',
  'Ng∆∞·ªùi l·∫° Online <i class="bi bi-person-fill-exclamation"></i>',
  'R·ªß r√™ vi·ªác x·∫•u <i class="bi bi-exclamation-triangle-fill"></i>',
];

/* ======= DOM ======= */
const game = document.getElementById('game');
const entitiesLayer = document.getElementById('entities');
const playerEl = document.getElementById('player');
const shadowEl = document.getElementById('shadow');

const scoreEl = document.getElementById('score');
const bestEl = document.getElementById('best');
const livesEl = document.getElementById('lives');
const levelEl = document.getElementById('level');
const diffBadge = document.getElementById('diffBadge');

const startOverlay = document.getElementById('startOverlay');
const gameOver = document.getElementById('gameOver');

const btnStart = document.getElementById('btnStart');
const btnPlayAgain = document.getElementById('btnPlayAgain');
const btnChange = document.getElementById('btnChange');
const btnPause = document.getElementById('btnPause');
const btnRestart = document.getElementById('btnRestart');
const btnMute = document.getElementById('btnMute');
const btnJump = document.getElementById('btnJump');

const finalScore = document.getElementById('finalScore');
const finalBest = document.getElementById('finalBest');
const toast = document.getElementById('toast');

const charChoice = document.getElementById('charChoice');
const diffChoice = document.getElementById('diffChoice');

/* ======= ƒê·ªò KH√ì (k√®m tham s·ªë v·∫≠t l√Ω) ======= */
const DIFFS = {
  // g: tr·ªçng l·ª±c (px/s^2), thrust: l·ª±c ƒë·∫©y l√™n khi gi·ªØ (px/s^2), maxAscend: t·ªëc ƒë·ªô bay l√™n t·ªëi ƒëa (px/s)
  easy:   {speed: 240, spawn: 1050, badRate: 0.52, lives:3, label:'D·ªÖ',   g:1300, thrust:1900, maxAscend: -620},
  normal: {speed: 300, spawn: 900,  badRate: 0.62, lives:2, label:'V·ª´a',  g:1550, thrust:2000, maxAscend: -700},
  hard:   {speed: 360, spawn: 780,  badRate: 0.72, lives:1, label:'Kh√≥',  g:1750, thrust:2100, maxAscend: -760},
};

let settings = { char:'blue', diff:'easy', muted:false };
let holdUp = false; // ƒëang gi·ªØ ƒë·ªÉ bay

/* ======= LOCALSTORAGE AN TO√ÄN ======= */
function loadBest(){
  try{
    const v = localStorage.getItem('friendrunner_best') ?? '0';
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  }catch(e){ return 0; }
}
function saveBest(v){
  try{ localStorage.setItem('friendrunner_best', String(v)); }catch(e){}
}
bestEl.textContent = loadBest();

/* ======= TR·∫†NG TH√ÅI GAME ======= */
const state = {
  w: 0, h: 0,
  gravity: 1500, // s·∫Ω b·ªã ghi ƒë√® theo DIFFS
  jumpVy: -620,  // fallback (kh√¥ng d√πng cho c∆° ch·∫ø gi·ªØ)
  groundY: 0,
  running:false, paused:false, over:false,
  score:0, best: loadBest(), lives: DIFFS[settings.diff].lives,
  level:1, levelTimer:0,
  speed: DIFFS[settings.diff].speed,
  spawnEvery: DIFFS[settings.diff].spawn,
  lastSpawn:0,
  badRate: DIFFS[settings.diff].badRate,
  shield:false, shieldTimer:0,

  player: { x:120, y:0, vy:0, w:56, h:56, onGround:true, skin:'blue', emoji:'üôÇ' },
  ents:[],
  lastT: performance.now()
};

/* ======= UI ======= */
function setChipActive(container, target){
  [...container.querySelectorAll('.chip')].forEach(c=>c.classList.remove('active'));
  target.classList.add('active');
}
charChoice.addEventListener('click', (e)=>{
  const chip = e.target.closest('.chip');
  if(!chip) return;
  setChipActive(charChoice, chip);
  settings.char = chip.dataset.char;
});
diffChoice.addEventListener('click', (e)=>{
  const chip = e.target.closest('.chip');
  if(!chip) return;
  setChipActive(diffChoice, chip);
  settings.diff = chip.dataset.diff;
  diffBadge.textContent = DIFFS[settings.diff].label;
});
document.getElementById('btnHow').addEventListener('click', ()=>{
  alert('ƒÇn ‚ÄúH√†nh vi t·ªët‚Äù ƒë·ªÉ +ƒëi·ªÉm, tr√°nh ‚ÄúH√†nh vi x·∫•u‚Äù. Nh·∫∑t ‚ÄúKhi√™n‚Äù ƒë·ªÉ ch·∫∑n 1 l·∫ßn va ch·∫°m (t·ªëi ƒëa 8 gi√¢y). T·ªëc ƒë·ªô & ƒë·ªô kh√≥ tƒÉng theo c·∫•p. Gi·ªØ ƒë·ªÉ bay!');
});

/* ======= √ÅP D·ª§NG C√ÄI ƒê·∫∂T ======= */
function applySettings(){
  const d = DIFFS[settings.diff];
  state.lives = d.lives; state.badRate = d.badRate; state.speed = d.speed; state.spawnEvery = d.spawn;
  state.gravity = d.g;

  state.level = 1; state.levelTimer = 0; state.score = 0; state.ents.length = 0;
  state.shield = false; state.shieldTimer = 0;
  livesEl.textContent = state.lives; levelEl.textContent = state.level; diffBadge.textContent = d.label;
  scoreEl.textContent = 0;
  entitiesLayer.innerHTML='';

  // set player skin
  const skins = {blue:['p-blue','üôÇ'], pink:['p-pink','üò∫'], green:['p-green','ü¶ä'], gold:['p-gold','üêª']};
  const [cls, emoji] = skins[settings.char] || skins.blue;
  playerEl.className = 'entity player '+cls;
  playerEl.textContent = emoji;
  state.player.emoji = emoji; state.player.skin = settings.char;
}

/* ======= K√çCH TH∆Ø·ªöC ======= */
function measure(){
  const rect = game.getBoundingClientRect();
  state.w = rect.width; state.h = rect.height;
  state.groundY = state.h * 0.82; // top of ground
}
window.addEventListener('resize', measure);
measure();

/* ======= V·∫º NH√ÇN V·∫¨T ======= */
function placePlayer(){
  const p = state.player;
  if(p.y > state.groundY - p.h){ p.y = state.groundY - p.h; p.vy = 0; p.onGround = true; }
  playerEl.style.transform = `translate(${p.x}px, ${p.y}px)`;
  shadowEl.style.left = (p.x + p.w/2)+'px';
}

/* ======= NG·∫™U NHI√äN ======= */
function rnd(a,b){ return a + Math.random()*(b-a) }

/* ======= SPAWN ENTITIES ======= */
function spawn(){
  const r = Math.random();
  let type = 'good';
  if(r < state.badRate) type='bad';
  else if(r > 0.92) type='power';

  const e = document.createElement('div');
  e.classList.add('entity');
  let speed = state.speed * rnd(.92,1.15);
  let y = state.groundY - 56;

  if(type==='bad'){
    e.classList.add('obstacle');
    e.innerHTML = BAD[(Math.random()*BAD.length)|0];
    y = state.groundY - rnd(48,64);
  }else if(type==='power'){
    e.classList.add('powerup');
    e.innerHTML = 'Khi√™n <i class="bi bi-shield-fill"></i>';
    y = state.groundY - rnd(120,160);
  }else{
    e.classList.add('collectible');
    const it = GOOD[(Math.random()*GOOD.length)|0];
    e.innerHTML = it.text;
    e.dataset.pts = it.pts;
    y = state.groundY - rnd(90,140);
  }

  const obj = {
    node: e, x: state.w + 20, y, w: 120, h: 44,
    vx: -speed, type, alive: true
  };
  entitiesLayer.appendChild(e);
  const rr = e.getBoundingClientRect();
  obj.w = rr.width; obj.h = rr.height;
  state.ents.push(obj);
}

/* ======= V√íNG L·∫∂P GAME ======= */
function step(t){
  const dt = Math.min(0.032, (t - state.lastT)/1000);
  state.lastT = t;
  if(!state.running || state.paused || state.over){ requestAnimationFrame(step); return; }

  // TƒÉng c·∫•p
  state.levelTimer += dt;
  if(state.levelTimer >= 12){
    state.levelTimer = 0;
    state.level++;
    state.speed *= 1.07;
    state.spawnEvery = Math.max(520, state.spawnEvery - 40);
    levelEl.textContent = state.level;
    flashScorePill('C·∫•p '+state.level);
    if(!settings.muted) makeBeep(520,80,.08);
  }

  // === V·∫¨T L√ù NH√ÇN V·∫¨T: NH·∫§N & GI·ªÆ ƒê·ªÇ BAY ===
  const p = state.player;
  const dcur = DIFFS[settings.diff];

  // tr·ªçng l·ª±c
  p.vy += (dcur.g || state.gravity) * dt;

  // gi·ªØ ƒë·ªÉ ƒë·∫©y l√™n
  if(holdUp){
    p.vy += -(dcur.thrust || 1900) * dt;
    const maxUp = (dcur.maxAscend || -650);
    if(p.vy < maxUp) p.vy = maxUp;
  }

  // c·∫≠p nh·∫≠t v·ªã tr√≠
  p.y += p.vy * dt;

  // ch·∫°m ƒë·∫•t
  if(p.y > state.groundY - p.h){
    p.y = state.groundY - p.h;
    p.vy = Math.max(0, p.vy);
  }

  // tr·∫ßn
  const topLimit = state.h * 0.06;
  if(p.y < topLimit){
    p.y = topLimit;
    if(p.vy < 0) p.vy = 0;
  }

  placePlayer();

  // Spawn theo th·ªùi gian
  state.lastSpawn += dt*1000;
  if(state.lastSpawn >= state.spawnEvery){
    state.lastSpawn = 0;
    spawn();
  }

  // Di chuy·ªÉn & va ch·∫°m
  const boundsP = playerEl.getBoundingClientRect();
  for(const obj of state.ents){
    if(!obj.alive) continue;
    obj.x += obj.vx * dt;
    obj.node.style.transform = `translate(${obj.x}px, ${obj.y}px)`;
    if(obj.x < -obj.w - 40){ obj.alive=false; obj.node.remove(); continue; }

    const br = obj.node.getBoundingClientRect();
    if(intersect(boundsP, br)){
      if(obj.type==='bad') handleHit(obj);
      else if(obj.type==='power') pickupShield(obj);
      else collectGood(obj);
    }
  }
  // d·ªçn b·ªõt
  if(state.ents.length>0 && state.ents.length % 25===0){
    state.ents = state.ents.filter(e=>e.alive);
  }

  requestAnimationFrame(step);
}

function intersect(a,b){
  return a.left < b.right && a.right > b.left && a.top < b.bottom && a.bottom > b.top;
}

/* ======= X·ª¨ L√ù S·ª∞ KI·ªÜN VA CH·∫†M ======= */
function handleHit(obj){
  obj.alive=false; safeRemove(obj.node);
  if(state.shield){
    state.shield=false;
    playerEl.style.boxShadow = '0 10px 22px rgba(0,0,0,.15), inset 0 0 0 2px #ffffff22';
    showToast('Khi√™n ƒë√£ ch·∫∑n va ch·∫°m!', 900);
    if(!settings.muted) makeBeep(260,90,.08);
    return;
  }
  state.lives--; livesEl.textContent = Math.max(0,state.lives);
  flashRed();
  if(!settings.muted) makeBeep(180,120,.12);
  if(state.lives<=0) return gameOverNow();
}

function pickupShield(obj){
  obj.alive=false; safeRemove(obj.node);
  state.shield = true; state.shieldTimer = 8;
  playerEl.style.boxShadow = '0 0 0 3px #fbbf24, 0 10px 22px rgba(0,0,0,.15)';
  showToast('Nh·∫≠n Khi√™n (8s)!', 900);
  if(!settings.muted) makeBeep(820,80,.09);
}

function collectGood(obj){
  obj.alive=false; safeRemove(obj.node);
  const pts = Number(obj.node.dataset.pts)||8;
  state.score += pts;
  scoreEl.textContent = state.score;
  showToast('+'+pts+' ƒëi·ªÉm', 650);
  if(!settings.muted) makeBeep(980,60,.08);
}

/* ======= HI·ªÜU ·ª®NG NHANH ======= */
function showToast(msg, ms=700){
  toast.innerHTML = msg;
  toast.classList.add('show');
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=>toast.classList.remove('show'), ms);
}
function flashRed(){
  game.style.transition='background-color .12s';
  game.style.backgroundColor='#ffd9d9';
  setTimeout(()=>{ game.style.backgroundColor=''; }, 120);
}
function flashScorePill(txt){
  const pill = document.getElementById('scorePill');
  const old = pill.innerHTML;
  pill.innerHTML = `<i class="bi bi-lightning-fill text-warning"></i> ${txt}`;
  pill.style.transform='scale(1.06)';
  setTimeout(()=>{ pill.style.transform='scale(1)'; pill.innerHTML = old; }, 650);
}
function safeRemove(n){ try{ n.remove(); }catch(e){} }

/* ======= V√íNG ƒê·ªúI GAME ======= */
function startGame(){
  startOverlay.classList.add('d-none');
  gameOver.classList.add('d-none');
  state.over=false; state.running=true; state.paused=false;
  state.lastT = performance.now();
  measure();
  const p = state.player;
  p.x = 120; p.y = state.groundY - p.h; p.vy=0; p.onGround=true;
  placePlayer();
  requestAnimationFrame(step);
}
function gameOverNow(){
  state.over=true; state.running=false;
  finalScore.textContent = state.score;
  state.best = Math.max(state.best, state.score);
  bestEl.textContent = state.best; finalBest.textContent = state.best;
  saveBest(state.best);
  setTimeout(()=> gameOver.classList.remove('d-none'), 250);
}
function pauseToggle(){
  if(!state.running || state.over) return;
  state.paused = !state.paused;
  btnPause.innerHTML = state.paused ? `<i class="bi bi-play-fill"></i><span class="d-none d-sm-inline">Ti·∫øp t·ª•c</span>` : `<i class="bi bi-pause-fill"></i><span class="d-none d-sm-inline">T·∫°m d·ª´ng</span>`;
  if(!state.paused){ state.lastT = performance.now(); }
}

/* ======= S·ª∞ KI·ªÜN ======= */
btnStart.addEventListener('click', ()=>{ applySettings(); startGame(); });
btnPlayAgain.addEventListener('click', ()=>{ applySettings(); startGame(); });
btnChange.addEventListener('click', ()=>{
  gameOver.classList.add('d-none');
  startOverlay.classList.remove('d-none');
});
btnPause.addEventListener('click', pauseToggle);
btnRestart.addEventListener('click', ()=>{ applySettings(); startGame(); });
btnMute.addEventListener('click', ()=>{
  settings.muted = !settings.muted;
  btnMute.innerHTML = settings.muted ? `<i class="bi bi-volume-mute-fill"></i>` : `<i class="bi bi-volume-up-fill"></i>`;
});

/* NgƒÉn cu·ªôn khi nh·∫•n Space */
window.addEventListener('keydown', (e)=>{ if(e.code==='Space') e.preventDefault(); }, {passive:false});

/* B√ÄN PH√çM: gi·ªØ ƒë·ªÉ bay */
document.addEventListener('keydown', (e)=>{
  if(e.code === 'Space'){ holdUp = true; }
  else if(e.key==='p'||e.key==='P'){ pauseToggle(); }
  else if(e.key==='r'||e.key==='R'){ applySettings(); startGame(); }
});
document.addEventListener('keyup', (e)=>{
  if(e.code === 'Space'){ holdUp = false; }
});

/* C·∫¢M ·ª®NG/CHU·ªòT (pointer = h·ª£p nh·∫•t) */
const startHold = (e)=>{ e.preventDefault(); holdUp = true; };
const endHold   = (e)=>{ e.preventDefault(); holdUp = false; };

game.addEventListener('pointerdown', startHold, {passive:false});
game.addEventListener('pointerup',   endHold,   {passive:false});
game.addEventListener('pointercancel',endHold,  {passive:false});
btnJump.addEventListener('pointerdown', startHold, {passive:false});
btnJump.addEventListener('pointerup',   endHold,   {passive:false});
btnJump.addEventListener('pointercancel',endHold,  {passive:false});

/* ======= KH·ªûI T·∫†O ======= */
applySettings(); placePlayer();

/* ======= GUARDS ======= */
window.addEventListener('error', (ev)=>{
  console.warn('L·ªói ƒë√£ ƒë∆∞·ª£c b·∫Øt:', ev.message);
  showToast('ƒê√£ t·ª± ph·ª•c h·ªìi!', 900);
});
window.addEventListener('unhandledrejection', (ev)=>{
  console.warn('Promise l·ªói:', ev.reason);
  showToast('S·ª± c·ªë nh·ªè ƒë∆∞·ª£c x·ª≠ l√Ω', 900);
});
</script>

</body>
</html>
